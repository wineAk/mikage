import type { Route } from "./+types/watch";
import { createClient } from "~/library/supabase/server";
import { isNetworkAvailable, checkTarget } from "~/library/watch/checkTarget";
import {
  createIncidentInstatus,
  updateIncidentInstatus,
  resolveIncidentInstatus,
} from "~/library/watch/instatus";
import {
  createThreadGoogleChat,
  updateThreadGoogleChat,
  resolveThreadGoogleChat,
} from "~/library/watch/googlechat";
import type { LogResult } from "@/types/watch";
import type { Database } from "@/types/supabase";

export async function loader({ request }: Route.LoaderArgs) {
  // „Éë„É©„É°„Éº„Çø„ÇíÂèñÂæó
  const url = new URL(request.url);
  const key = url.searchParams.get("key");
  if (key !== process.env.VITE_WATCH_KEY) {
    return new Response(JSON.stringify({ error: "Invalid key." }), {
      status: 401,
      headers: { "Content-Type": "application/json" },
    });
  }

  const { supabase } = createClient(request, "mikage");

  // ÂØæË±°ÂèñÂæó
  const { data } = await supabase.from("targets").select("*");

  // „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÊúÄÂàù„Å´1Âõû„Å†„ÅëÂÆüË°å
  // const isAvailable = await isNetworkAvailable();
  // if (!isAvailable) {
  //   const results = (data ?? []).map(target => ({
  //     key: target.key,
  //     name: target.name,
  //     log: {
  //      responseTime: null,
  //      statusCode: null,
  //      statusMessage: null,
  //      errorName: "NetworkUnavailable",
  //      errorCode: "NO_INTERNET",
  //    }
  //    }));
  //    return new Response(JSON.stringify({ results }), {
  //      headers: { "Content-Type": "application/json" },
  //    });
  // }

  // ÂÖ®„Çø„Éº„Ç≤„ÉÉ„Éà„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÈùûÂêåÊúü„ÅßË°å„ÅÜ
  const checkPromises = (data ?? []).map(async (target) => {
    const { key, name, url, headers } = target;
    const log = await checkTarget({ url, headers });
    return { key, name, log };
  });
  // ÂÖ®„É¨„Çπ„Éù„É≥„Çπ„Çí„Åæ„Å®„ÇÅ„Å¶ÂèñÂæó
  const results = await Promise.all(checkPromises);
  // „Åæ„Å®„ÇÅ„Å¶DB„Å∏insert
  const insertRows = results.map(({ key, log }) => ({
    target_key: key,
    checked_at: new Date(),
    response_time: log.responseTime,
    status_code: log.statusCode,
    status_message: log.statusMessage,
    error_name: log.errorName,
    error_code: log.errorCode,
  }));
  const result = await supabase.from("logs").insert(insertRows);
  if (result) {
    console.log(`üìù ${insertRows.length}‰ª∂„ÅÆ„É≠„Ç∞„Çí„Åæ„Å®„ÇÅ„Å¶ÁôªÈå≤„Åó„Åæ„Åó„Åü`);
  } else {
    console.log(`‚ùå „É≠„Ç∞ÁôªÈå≤„Å´Â§±Êïó„Åó„Åæ„Åó„Åü`);
  }

  /*
  // „ÉÜ„Çπ„Éà„Éá„Éº„Çø
  const resultsStable = [
    {
      key: "works09",
      name: "Works09",
      log: {
        startDate: 1747274301570,
        responseTime: 541,
        statusCode: 200,
        statusMessage: "OK",
        errorName: null,
        errorCode: null,
      },
    },
    {
      key: "saaske00",
      name: "Saaske00",
      log: {
        startDate: 1747274301852,
        responseTime: 481,
        statusCode: 200,
        statusMessage: "OK",
        errorName: null,
        errorCode: null,
      },
    },
    {
      key: "saaske01",
      name: "Saaske01",
      log: {
        startDate: 1747274301661,
        responseTime: 377,
        statusCode: 200,
        statusMessage: "OK",
        errorName: null,
        errorCode: null,
      },
    },
    {
      key: "saaske02",
      name: "Saaske02",
      log: {
        startDate: 1747274301695,
        responseTime: 485,
        statusCode: 200,
        statusMessage: "OK",
        errorName: null,
        errorCode: null,
      },
    },
    {
      key: "saaske03",
      name: "Saaske03",
      log: {
        startDate: 1747274301857,
        responseTime: 495,
        statusCode: 200,
        statusMessage: "OK",
        errorName: null,
        errorCode: null,
      },
    },
    {
      key: "saaske_api",
      name: "Saaske API",
      log: {
        startDate: 1747274301603,
        responseTime: 387,
        statusCode: 200,
        statusMessage: "OK",
        errorName: null,
        errorCode: null,
      },
    },
    {
      key: "webform",
      name: "Web„Éï„Ç©„Éº„É†",
      log: {
        startDate: 1747274301832,
        responseTime: 585,
        statusCode: 200,
        statusMessage: "OK",
        errorName: null,
        errorCode: null,
      },
    },
    {
      key: "webtracking",
      name: "WebË°åÂãïËß£Êûê",
      log: {
        startDate: 1747274301788,
        responseTime: 4,
        statusCode: 200,
        statusMessage: "OK",
        errorName: null,
        errorCode: null,
      },
    },
    {
      key: "works07",
      name: "Works07",
      log: {
        startDate: 1747274301865,
        responseTime: 593,
        statusCode: 200,
        statusMessage: "OK",
        errorName: null,
        errorCode: null,
      },
    },
    {
      key: "saaske04",
      name: "Saaske04",
      log: {
        startDate: 1747274301649,
        responseTime: 478,
        statusCode: 200,
        statusMessage: "OK",
        errorName: null,
        errorCode: null,
      },
    },
    {
      key: "saaske05",
      name: "Saaske05",
      log: {
        startDate: 1747274301861,
        responseTime: 407,
        statusCode: 200,
        statusMessage: "OK",
        errorName: null,
        errorCode: null,
      },
    },
    {
      key: "saaske07",
      name: "Saaske07",
      log: {
        startDate: 1747274301623,
        responseTime: 337,
        statusCode: 200,
        statusMessage: "OK",
        errorName: null,
        errorCode: null,
      },
    },
    {
      key: "saaske09",
      name: "Saaske09",
      log: {
        startDate: 1747274301658,
        responseTime: 486,
        statusCode: 200,
        statusMessage: "OK",
        errorName: null,
        errorCode: null,
      },
    },
  ];
  const resultsAllError = [
    {
      key: "works09",
      name: "Works09",
      log: {
        startDate: 1747274301570,
        responseTime: 10003,
        statusCode: 408,
        statusMessage: "Request Timeout",
        errorName: "TimeoutError",
        errorCode: "ETIMEDOUT",
      },
    },
    {
      key: "saaske00",
      name: "Saaske00",
      log: {
        startDate: 1747274301852,
        responseTime: 10003,
        statusCode: 408,
        statusMessage: "Request Timeout",
        errorName: "TimeoutError",
        errorCode: "ETIMEDOUT",
      },
    },
    {
      key: "saaske01",
      name: "Saaske01",
      log: {
        startDate: 1747274301661,
        responseTime: 377,
        statusCode: 200,
        statusMessage: "OK",
        errorName: null,
        errorCode: null,
      },
    },
    {
      key: "saaske02",
      name: "Saaske02",
      log: {
        startDate: 1747274301695,
        responseTime: 485,
        statusCode: 200,
        statusMessage: "OK",
        errorName: null,
        errorCode: null,
      },
    },
    {
      key: "saaske03",
      name: "Saaske03",
      log: {
        startDate: 1747274301857,
        responseTime: 495,
        statusCode: 200,
        statusMessage: "OK",
        errorName: null,
        errorCode: null,
      },
    },
    {
      key: "saaske_api",
      name: "Saaske API",
      log: {
        startDate: 1747274301603,
        responseTime: 387,
        statusCode: 200,
        statusMessage: "OK",
        errorName: null,
        errorCode: null,
      },
    },
    {
      key: "webform",
      name: "Web„Éï„Ç©„Éº„É†",
      log: {
        startDate: 1747274301832,
        responseTime: 585,
        statusCode: 200,
        statusMessage: "OK",
        errorName: null,
        errorCode: null,
      },
    },
    {
      key: "webtracking",
      name: "WebË°åÂãïËß£Êûê",
      log: {
        startDate: 1747274301788,
        responseTime: 4,
        statusCode: 200,
        statusMessage: "OK",
        errorName: null,
        errorCode: null,
      },
    },
    {
      key: "works07",
      name: "Works07",
      log: {
        startDate: 1747274301865,
        responseTime: 593,
        statusCode: 200,
        statusMessage: "OK",
        errorName: null,
        errorCode: null,
      },
    },
    {
      key: "saaske04",
      name: "Saaske04",
      log: {
        startDate: 1747274301649,
        responseTime: 478,
        statusCode: 200,
        statusMessage: "OK",
        errorName: null,
        errorCode: null,
      },
    },
    {
      key: "saaske05",
      name: "Saaske05",
      log: {
        startDate: 1747274301861,
        responseTime: 407,
        statusCode: 200,
        statusMessage: "OK",
        errorName: null,
        errorCode: null,
      },
    },
    {
      key: "saaske07",
      name: "Saaske07",
      log: {
        startDate: 1747274301623,
        responseTime: 337,
        statusCode: 200,
        statusMessage: "OK",
        errorName: null,
        errorCode: null,
      },
    },
    {
      key: "saaske09",
      name: "Saaske09",
      log: {
        startDate: 1747274301658,
        responseTime: 486,
        statusCode: 200,
        statusMessage: "OK",
        errorName: null,
        errorCode: null,
      },
    },
  ];
  const resultsSaaskeError = [
    {
      key: "works09",
      name: "Works09",
      log: {
        startDate: 1747274301570,
        responseTime: 541,
        statusCode: 200,
        statusMessage: "OK",
        errorName: null,
        errorCode: null,
      },
    },
    {
      key: "saaske00",
      name: "Saaske00",
      log: {
        startDate: 1747274301852,
        responseTime: 10003,
        statusCode: 408,
        statusMessage: "Request Timeout",
        errorName: "TimeoutError",
        errorCode: "ETIMEDOUT",
      },
    },
    {
      key: "saaske01",
      name: "Saaske01",
      log: {
        startDate: 1747274301661,
        responseTime: 23,
        statusCode: 502,
        statusMessage: "Bad Gateway",
        errorName: null,
        errorCode: null,
      },
    },
    {
      key: "saaske02",
      name: "Saaske02",
      log: {
        startDate: 1747274301695,
        responseTime: 485,
        statusCode: 200,
        statusMessage: "OK",
        errorName: null,
        errorCode: null,
      },
    },
    {
      key: "saaske03",
      name: "Saaske03",
      log: {
        startDate: 1747274301857,
        responseTime: 495,
        statusCode: 200,
        statusMessage: "OK",
        errorName: null,
        errorCode: null,
      },
    },
    {
      key: "saaske_api",
      name: "Saaske API",
      log: {
        startDate: 1747274301603,
        responseTime: 387,
        statusCode: 200,
        statusMessage: "OK",
        errorName: null,
        errorCode: null,
      },
    },
    {
      key: "webform",
      name: "Web„Éï„Ç©„Éº„É†",
      log: {
        startDate: 1747274301832,
        responseTime: 585,
        statusCode: 200,
        statusMessage: "OK",
        errorName: null,
        errorCode: null,
      },
    },
    {
      key: "webtracking",
      name: "WebË°åÂãïËß£Êûê",
      log: {
        startDate: 1747274301788,
        responseTime: 4,
        statusCode: 200,
        statusMessage: "OK",
        errorName: null,
        errorCode: null,
      },
    },
    {
      key: "works07",
      name: "Works07",
      log: {
        startDate: 1747274301865,
        responseTime: 593,
        statusCode: 200,
        statusMessage: "OK",
        errorName: null,
        errorCode: null,
      },
    },
    {
      key: "saaske04",
      name: "Saaske04",
      log: {
        startDate: 1747274301649,
        responseTime: 478,
        statusCode: 200,
        statusMessage: "OK",
        errorName: null,
        errorCode: null,
      },
    },
    {
      key: "saaske05",
      name: "Saaske05",
      log: {
        startDate: 1747274301861,
        responseTime: 407,
        statusCode: 200,
        statusMessage: "OK",
        errorName: null,
        errorCode: null,
      },
    },
    {
      key: "saaske07",
      name: "Saaske07",
      log: {
        startDate: 1747274301623,
        responseTime: 337,
        statusCode: 200,
        statusMessage: "OK",
        errorName: null,
        errorCode: null,
      },
    },
    {
      key: "saaske09",
      name: "Saaske09",
      log: {
        startDate: 1747274301658,
        responseTime: 486,
        statusCode: 200,
        statusMessage: "OK",
        errorName: null,
        errorCode: null,
      },
    },
  ];
  const resultsWorksError = [
    {
      key: "works09",
      name: "Works09",
      log: {
        startDate: 1747274301570,
        responseTime: 10003,
        statusCode: 408,
        statusMessage: "Request Timeout",
        errorName: "TimeoutError",
        errorCode: "ETIMEDOUT",
      },
    },
    {
      key: "saaske00",
      name: "Saaske00",
      log: {
        startDate: 1747274301852,
        responseTime: 486,
        statusCode: 200,
        statusMessage: "OK",
        errorName: null,
        errorCode: null,
      },
    },
    {
      key: "saaske01",
      name: "Saaske01",
      log: {
        startDate: 1747274301661,
        responseTime: 377,
        statusCode: 200,
        statusMessage: "OK",
        errorName: null,
        errorCode: null,
      },
    },
    {
      key: "saaske02",
      name: "Saaske02",
      log: {
        startDate: 1747274301695,
        responseTime: 485,
        statusCode: 200,
        statusMessage: "OK",
        errorName: null,
        errorCode: null,
      },
    },
    {
      key: "saaske03",
      name: "Saaske03",
      log: {
        startDate: 1747274301857,
        responseTime: 495,
        statusCode: 200,
        statusMessage: "OK",
        errorName: null,
        errorCode: null,
      },
    },
    {
      key: "saaske_api",
      name: "Saaske API",
      log: {
        startDate: 1747274301603,
        responseTime: 387,
        statusCode: 200,
        statusMessage: "OK",
        errorName: null,
        errorCode: null,
      },
    },
    {
      key: "webform",
      name: "Web„Éï„Ç©„Éº„É†",
      log: {
        startDate: 1747274301832,
        responseTime: 585,
        statusCode: 200,
        statusMessage: "OK",
        errorName: null,
        errorCode: null,
      },
    },
    {
      key: "webtracking",
      name: "WebË°åÂãïËß£Êûê",
      log: {
        startDate: 1747274301788,
        responseTime: 4,
        statusCode: 200,
        statusMessage: "OK",
        errorName: null,
        errorCode: null,
      },
    },
    {
      key: "works07",
      name: "Works07",
      log: {
        startDate: 1747274301865,
        responseTime: 593,
        statusCode: 200,
        statusMessage: "OK",
        errorName: null,
        errorCode: null,
      },
    },
    {
      key: "saaske04",
      name: "Saaske04",
      log: {
        startDate: 1747274301649,
        responseTime: 478,
        statusCode: 200,
        statusMessage: "OK",
        errorName: null,
        errorCode: null,
      },
    },
    {
      key: "saaske05",
      name: "Saaske05",
      log: {
        startDate: 1747274301861,
        responseTime: 407,
        statusCode: 200,
        statusMessage: "OK",
        errorName: null,
        errorCode: null,
      },
    },
    {
      key: "saaske07",
      name: "Saaske07",
      log: {
        startDate: 1747274301623,
        responseTime: 337,
        statusCode: 200,
        statusMessage: "OK",
        errorName: null,
        errorCode: null,
      },
    },
    {
      key: "saaske09",
      name: "Saaske09",
      log: {
        startDate: 1747274301658,
        responseTime: 486,
        statusCode: 200,
        statusMessage: "OK",
        errorName: null,
        errorCode: null,
      },
    },
  ];
  const results = resultsStable;
  */

  // „Ç®„É©„Éº„Åå„ÅÇ„ÇãÈÖçÂàó„ÇíËøî„ÅôÈñ¢Êï∞
  function findErrorResults(
    results: LogResult[],
    key: string | string[]
  ): LogResult[] {
    const keys = Array.isArray(key) ? key : [key];
    const filtered = results.filter(
      (result) =>
        keys.some((k) => result.key.includes(k)) &&
        (result.log.statusCode !== 200 ||
          (result.log.errorCode !== null &&
            result.log.errorCode !== "NO_INTERNET"))
    );
    return filtered;
  }
  const saaskeErrors = findErrorResults(results, "saaske");
  const worksErrors = findErrorResults(results, "works");
  //const anyErrors = findErrorResults(results, ["saaske", "works"]);

  // „Ç§„É≥„Ç∑„Éá„É≥„ÉàÁä∂Ê≥Å„ÇíÂèñÂæó
  type Incident = Database["mikage"]["Tables"]["incident"]["Row"];
  const { data: incidentData }: { data: Incident[] | null } = await supabase
    .from("incident")
    .select("*");
  const saaskeIncident = incidentData?.find(
    (incident) => incident.key === "saaske"
  );
  const worksIncident = incidentData?.find(
    (incident) => incident.key === "works"
  );
  if (!saaskeIncident || !worksIncident) {
    return new Response(JSON.stringify({ results }), {
      headers: { "Content-Type": "application/json" },
    });
  }

  // „Ç§„É≥„Ç∑„Éá„É≥„Éà„ÇíÊõ¥Êñ∞„Åô„ÇãÈñ¢Êï∞
  async function handleIncident(
    label: string,
    errors: LogResult[],
    incident: Incident
  ): Promise<any> {
    const { last_updated, googlechat_name, instatus_id } = incident;
    const now = new Date();
    // --- „Ç®„É©„Éº„Åå„ÅÇ„ÇãÂ†¥Âêà ---
    if (errors.length > 0) {
      // 1ÂõûÁõÆ
      if (!last_updated && !googlechat_name) {
        console.log(`${label} „Ç®„É©„Éº1ÂõûÁõÆ`);
        // upsert„Åßlast_updated„ÅÆ„ÅøÊõ¥Êñ∞
        const supabaseResult = await supabase
          .from("incident")
          .upsert([{ key: label, last_updated: now }], { onConflict: "key" });
        return { supabaseResult, googleChatResult: null, instatusResult: null };
      }
      // 2ÂõûÁõÆ
      if (last_updated && !googlechat_name) {
        console.log(`${label} „Ç®„É©„Éº2ÂõûÁõÆ`);
        const googleChatResult = await createThreadGoogleChat(errors);
        const started = new Date(last_updated).toISOString();
        const instatusResult =
          label === "works" ? await createIncidentInstatus(started) : null;
        // 2ÂõûÁõÆ„ÅØgooglechat_name„Å®instatus_id„Çí„Çª„ÉÉ„Éà
        const supabaseResult = await supabase
          .from("incident")
          .update({
            googlechat_name: googleChatResult.thread.name,
            instatus_id: instatusResult?.id,
          })
          .eq("key", label);
        return { supabaseResult, googleChatResult, instatusResult };
      }
      // 3ÂõûÁõÆ‰ª•Èôç
      if (last_updated && googlechat_name) {
        console.log(`${label} „Ç®„É©„Éº3ÂõûÁõÆ‰ª•Èôç`);
        const diffMin =
          (now.getTime() - new Date(last_updated).getTime()) / 60000;
        const googleChatResult = await updateThreadGoogleChat(
          errors,
          googlechat_name
        );
        if (label === "works" && diffMin >= 5 && instatus_id) {
          console.log(`${label} „Ç®„É©„Éº3ÂõûÁõÆ‰ª•Èôç & 5ÂàÜÁµåÈÅé`);
          const started = now.toISOString();
          const instatusResult = await updateIncidentInstatus(
            instatus_id,
            started
          );
          const supabaseResult = await supabase
            .from("incident")
            .update({ last_updated: now })
            .eq("key", label);
          return { supabaseResult, googleChatResult, instatusResult };
        }
        return { supabaseResult: null, googleChatResult, instatusResult: null };
      }
    }
    // --- „Ç®„É©„Éº„Åå„Å™„ÅÑÂ†¥Âêà ---
    // ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
    if (!last_updated && !googlechat_name) {
      console.log(`${label} „Å™„Å´„ÇÇ„Åó„Å™„ÅÑ`);
      return {
        supabaseResult: null,
        googleChatResult: null,
        instatusResult: null,
      };
    }
    // Êó•‰ªò„Å†„Åë„ÅÇ„Çã or ‰∏°Êñπ„ÅÇ„Çã„Å®„Åç„ÅØÂÖ®„Å¶Á©∫„Å´„Åô„Çã
    if (last_updated) {
      let googleChatResult = null;
      let instatusResult = null;
      if (googlechat_name) {
        console.log(`${label} ‰∏°Êñπ„ÅÇ„Çã„Å®„Åç„ÅØÂÖ®„Å¶Á©∫„Å´„Åô„Çã`);
        googleChatResult = await resolveThreadGoogleChat(
          errors,
          googlechat_name
        );
        if (label === "works" && instatus_id) {
          const started = now.toISOString();
          instatusResult = await resolveIncidentInstatus(instatus_id, started);
        }
      } else {
        console.log(`${label} Êó•‰ªò„Å†„Åë„ÅÇ„Çã„Å®„Åç„ÅØÂÖ®„Å¶Á©∫„Å´„Åô„Çã`);
      }
      const supabaseResult = await supabase
        .from("incident")
        .update({
          last_updated: null,
          googlechat_name: null,
          instatus_id: null,
        })
        .eq("key", label);
      return { supabaseResult, googleChatResult, instatusResult };
    }
  }

  // Âëº„Å≥Âá∫„Åó
  const worksResult = await handleIncident(
    "works",
    worksErrors,
    worksIncident!
  );
  const saaskeResult = await handleIncident(
    "saaske",
    saaskeErrors,
    saaskeIncident!
  );

  return new Response(JSON.stringify({ results, worksResult, saaskeResult }), {
    headers: { "Content-Type": "application/json" },
  });
}
